============================= test session starts ==============================
platform darwin -- Python 3.9.6, pytest-8.4.2, pluggy-1.6.0
rootdir: /Users/pranithred/Documents/Neued frontend practise/Impact-Analyzer/backend
configfile: pytest.ini
testpaths: tests
plugins: asyncio-1.2.0, anyio-3.7.1, cov-7.0.0
asyncio: mode=strict, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 10 items

tests/test_github_compare.py .                                           [ 10%]
tests/test_health.py .                                                   [ 20%]
tests/test_helpers.py ...                                                [ 50%]
tests/test_llm.py .                                                      [ 60%]
tests/test_projects.py .                                                 [ 70%]
tests/test_scan_api.py F                                                 [ 80%]
tests/test_subscriptions.py .                                            [ 90%]
tests/test_subscriptions_full.py .                                       [100%]

=================================== FAILURES ===================================
____________________________ test_scan_no_previous _____________________________

mock_llm = <MagicMock name='detect_changes' id='4502682400'>

    @patch("app.main.detect_changes", return_value="false <p>No changes detected</p>")
    def test_scan_no_previous(mock_llm):
        app.dependency_overrides[get_db] = fake_db
        payload = {
            "repo_url": "https://github.com/test/repo",
            "commit": "abc123",
            "tag_name": "v1",
            "data": [{"method": "GET", "path": "/x"}]
        }
    
        response = client.post("/api/scan", json=payload)
        assert response.status_code == 200
>       assert "Scan stored" in response.text
E       assert 'Scan stored' in '"ok"'
E        +  where '"ok"' = <Response [200 OK]>.text

tests/test_scan_api.py:49: AssertionError
----------------------------- Captured stdout call -----------------------------
https://github.com/test/repo abc123 repo v1 [{"method": "GET", "path": "/x"}]
=============================== warnings summary ===============================
../../../../Library/Python/3.9/lib/python/site-packages/starlette/formparsers.py:12
  /Users/pranithred/Library/Python/3.9/lib/python/site-packages/starlette/formparsers.py:12: PendingDeprecationWarning: Please use `import python_multipart` instead.
    import multipart

app/config.py:5
  /Users/pranithred/Documents/Neued frontend practise/Impact-Analyzer/backend/app/config.py:5: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class Settings(BaseSettings):

app/database.py:8
  /Users/pranithred/Documents/Neued frontend practise/Impact-Analyzer/backend/app/database.py:8: MovedIn20Warning: The ``declarative_base()`` function is now available as sqlalchemy.orm.declarative_base(). (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    Base = declarative_base()

../../../../Library/Python/3.9/lib/python/site-packages/urllib3/__init__.py:35
  /Users/pranithred/Library/Python/3.9/lib/python/site-packages/urllib3/__init__.py:35: NotOpenSSLWarning: urllib3 v2 only supports OpenSSL 1.1.1+, currently the 'ssl' module is compiled with 'LibreSSL 2.8.3'. See: https://github.com/urllib3/urllib3/issues/3020
    warnings.warn(

app/main.py:47
  /Users/pranithred/Documents/Neued frontend practise/Impact-Analyzer/backend/app/main.py:47: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    @app.on_event("startup")

../../../../Library/Python/3.9/lib/python/site-packages/fastapi/applications.py:4495
  /Users/pranithred/Library/Python/3.9/lib/python/site-packages/fastapi/applications.py:4495: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    return self.router.on_event(event_type)

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
================================ tests coverage ================================
_______________ coverage: platform darwin, python 3.9.6-final-0 ________________

Name              Stmts   Miss  Cover   Missing
-----------------------------------------------
app/__init__.py       0      0   100%
app/config.py        13      0   100%
app/database.py      14      5    64%   11, 14-18
app/main.py         237     89    62%   49, 78-90, 147, 159, 203-204, 208-227, 238, 264-283, 287-289, 309-311, 318-352, 375-378, 389-413, 424-433, 436-437
app/models.py        57      6    89%   19, 23, 40, 44, 59, 63
-----------------------------------------------
TOTAL               321    100    69%
Coverage annotated source written to dir reports/annotate
Coverage XML written to file reports/coverage.xml
=========================== short test summary info ============================
FAILED tests/test_scan_api.py::test_scan_no_previous - assert 'Scan stored' i...
=================== 1 failed, 9 passed, 6 warnings in 1.46s ====================
